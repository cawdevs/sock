
  <html lang="es">
<head>


<script>
    try {
        // Primero, intenta conectar usando la wallet propia si hay una clave privada almacenada
        const privateKey = localStorage.getItem("privateKey");
        console.log("privateKey" + privateKey ); 

        if (localStorage.getItem("privateKey")) {
             window.location.href = 'principal_new.html';
            
        } 
           
        // Luego, si no hay wallet propia, intenta conectar con MetaMask
        //else if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask ) {
        //     window.location.href = 'principal_new.html';
        //} 
        // Si no hay MetaMask ni una clave privada, muestra un error
        else {
            console.error("No se detectó clave privada (Metamask)");
            
        }

    } catch (error) {
        console.error("No hay privateKey en el cache:", error);
    }

</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOCK PUPPETS</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
    
    <style>
       html, body {
            height: 100%;
            margin: 0;
            font-family: "Poppins", sans-serif;
            background: linear-gradient(45deg, lime, darkgreen);
        }
        .wrapper {
            display: flex;
            align-items: center;
            flex-direction: column; 
            justify-content: center;
            width: 100%;
            min-height: 80%;
            padding: 20px;
        }
        #formContent {
            border-radius: 10px;
            background: white;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        h4 {
            margin-bottom: 20px;
            color: #cccccc;
        }
        .underlineHover:hover {
            color: #0d0d0d;
            border-bottom: 2px solid #5fbae9;
        }
        input[type=text], input[type=submit], button {
            width: 85%;
            padding: 15px;
            margin: 5px 0;
            font-size: 16px;
            border: 2px solid #f6f6f6;
            border-radius: 5px;
            background-color: #f6f6f6;
            text-align: center;
        }
        input[type=submit], button {
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            text-transform: uppercase;
            font-size: 16px;
        }
        input[type=submit]:hover, button:hover {
            background-color: green;
        }
    </style>




</head>

<body>
<br>
<br>
<center>
    <div>
        <a href="whiteDocument.html" target="_blank">
            <img src="images/icons/document_icon.SVG" alt="Document Icon" width="25" style="margin-left: 20px;">
        </a>
        <a href="https://github.com/cawdevs" target="_blank" rel="noopener noreferrer">
            <img src="images/logoG.SVG" alt="GitHub Logo" width="25" style="margin-left: 20px;">
        </a>
        <a href="https://x.com/puppets_token" target="_blank" rel="noopener noreferrer">
            <img src="images/logoX.svg" alt="X Logo" width="25" style="margin-left: 20px;">
        </a>

        <a href="https://t.me/TheSockCoin" target="_blank" rel="noopener noreferrer">
            <img src="images/logoT.SVG" alt="X Logo" width="25" style="margin-left: 20px;">
        </a>

    </div>
</center>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3"></div>
        <div class="col-sm-6">
            <div class="wrapper fadeInDown">
                <img src='images/logosock.SVG' alt="Logo Sock" width="300">
                <br><br>
                <div id="formContent">
                    <h4 class="underlineHover">Decentralized Finance Social Network</h4>
                    <input type="text" id="password" class="fadeIn third" placeholder="Password" maxlength="8">

          <input type="file" id="fileInput" accept=".key" style="display: none;" onchange="updateButtonOnFileSelect()">
<!-- Botón personalizado para cargar archivo -->
<button type="button" id="actionButton" class="fadeIn fourth" onclick="handleButtonClick()">Load Key Wallet</button>

      <!--    <input id="actionButton" type="submit" value="Create wallet" onclick="handleWalletAction()">
                    <br>-->
                 
           <div style="display: flex; justify-content: space-between; margin-top: 20px">
                <a class="underlineHover" onclick="createWallet()" style="display: inline-block;">New Wallet</a>

                <a class="underlineHover" onclick="goToHelp()" style="display: inline-block;"> <span class="glyphicon glyphicon-question-sign" style="color: black; font-size: 24px;"></a>

                <a class="underlineHover" onclick="goToExplain()" style="display: inline-block;"><span class="glyphicon glyphicon-info-sign" style="color: black; font-size: 24px;"></a>
       

                <a class="underlineHover" onclick="goToSockMetamask()" style="display: inline-block;">Metamask Enter</a>

           </div>
           
             <center>
           <div style=" justify-content: space-between; margin-top: 20px">

              <a class="underlineHover" style="display: inline-block;" href="https://raw.githubusercontent.com/cawdevs/sock/master/files/theSocksApp.apk" download>Descargar Apk para Android</a>     </center>   

                </div>
            </div>
        </div>
        <div class="col-sm-3"></div>
    </div>
</div>

<script>
    function goToHelp(){

        alert("1 -Pon una/tu contraseña \n\n 2 -Crea una wallet (New Wallet) si ya la tienes pasa al punto 3 \n\t a) se descargará file.key en “/descargas” \n\t El archivo contiene la credenciales de tu billetera \n\n 3 -Presiona el botón LOAD KEY WALLET \n\t a) Busca y carga el archivo “file.key” \n\n 4 -presiona ENTER \n\n Si tienes Metamask (Metamask Enter)");
        
    }
    function goToExplain(){
        alert("TheSocks.net es una red social descentralizada única en su tipo, diseñada para revolucionar la forma en que interactuamos, compartimos contenido y manejamos nuestras finanzas en línea. A diferencia de las redes tradicionales, TheSocks.net no solo te permite hacer publicaciones y enviar mensajes, sino que también integra un ecosistema financiero innovador impulsado por su propia criptomoneda, llamada SOCK. ");
    }




    function goToMainPage() {
        window.location.href = 'principal_new.html';
    }

    function goToSockMetamask() {
        window.location.href = 'principal_new.html';
    }

    async function createWallet() {
        const password = document.getElementById('password').value.trim(); // 
        if (!password) {
                alert("La contraseña es necesaria.");
        return;
        }
        
        const wallet = ethers.Wallet.createRandom();
        await almacenarClaveEnArchivo(wallet.privateKey); // Cambiado para guardar la clave en archivo
        //alert(`Nueva billetera creada:\n ${wallet.address}`);
        //alert(`Nueva billetera creada:\nDirección: ${wallet.address}\nClave privada guardada en el archivo.`);
        //checkWallet();
    }

    // Función para encriptar y almacenar la clave privada en un archivo
    async function almacenarClaveEnArchivo(privateKey) {
        const password = document.getElementById('password').value.trim(); // Asegúrate de eliminar espacios
        if (!password) {
                alert("Una contraseña es necesaria.");
        return;
    }

        const encryptedKey = CryptoJS.AES.encrypt(privateKey, password).toString();

        // Crear un archivo .key con la clave encriptada
        const blob = new Blob([encryptedKey], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'file.key';  // El nombre del archivo será 'file.key'
        link.click();  // Simula un clic para descargar el archivo

        //alert("Billetera creada y protegida exitosamente.");
    }


function updateButtonOnFileSelect() {
    const actionButton = document.getElementById('actionButton');
    const fileInput = document.getElementById('fileInput');

    // Cambia el texto del botón a "Enter" cuando se selecciona el archivo
    if (fileInput.files.length > 0 && fileInput.files[0].name === 'file.key') {
        actionButton.innerText = 'ENTER';
        actionButton.setAttribute('data-action', 'ENTER'); // Añade un atributo de acción para indicar que el botón ahora ejecuta la función
    }
}

function handleButtonClick() {
    const actionButton = document.getElementById('actionButton');

    if (actionButton.getAttribute('data-action') === 'ENTER') {
        handleWalletAction(); // Ejecuta la función cuando el botón dice "Enter"
    } else {
        document.getElementById('fileInput').click(); // Abre el selector de archivo si el botón dice "Load Key Wallet"
    }
}

async function handleWalletAction() {
    const actionButton = document.getElementById('actionButton');
    const password = document.getElementById('password').value.trim();
    
    if (!password) {
        alert("La contraseña es necesaria.");
        return;
    }

    if (actionButton.innerText === 'ENTER') {
        // Desencripta la clave privada del archivo cargado
        const privateKey = await obtenerClaveDesencriptada(password);
        if (privateKey) {
            //alert(`Billetera cargada exitosamente. Clave privada: ${privateKey}`);
            //sessionStorage.setItem('privateKey', privateKey);
            localStorage.setItem("privateKey", privateKey);
            localStorage.setItem("password", password);

            goToMainPage();
        }
    }
}

function handleFileSelect(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];

    if (!file || !file.name.endsWith('.key')) {
            alert("Por favor, carga un archivo file.key");
            return null;
    }
    
    //if (file && file.name === 'file.key') {
    //    alert('Archivo .key cargado correctamente.');       
    //} else {
    //    alert('Por favor, selecciona un archivo válido.');
    //}
}

// En lugar de invocar la función `checkWallet` en el `window.onload`, puedes conectar la verificación a tu manejador de evento de selección de archivo:
document.getElementById('fileInput').addEventListener('change', handleFileSelect);

/*
function check_privatekey() {
    try {
        // Primero, intenta conectar usando la wallet propia si hay una clave privada almacenada
        const privateKey = localStorage.getItem("privateKey");
        console.log("privateKey" + privateKey ); 

        if (localStorage.getItem("privateKey")) {
            goToMainPage();
            
        } 
           
        // Luego, si no hay wallet propia, intenta conectar con MetaMask
        else if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask ) {
            goToSockMetamask();
        } 
        // Si no hay MetaMask ni una clave privada, muestra un error
        else {
            console.error("No se detectó clave privada (Metamask)");
            return;
        }

    } catch (error) {
        console.error("No hay privateKey en el cache:", error);
    }
}

*/
async function obtenerClaveDesencriptada(password) {
    const fileInput = document.getElementById('fileInput'); // Asegúrate de tener este input en tu HTML
    const file = fileInput.files[0]; // Obtén el archivo cargado previamente

    //if (!file || file.name !== 'file.key') {
    //    alert("Por favor, carga un archivo válido ");
    //    return null;
    //}

    if (!file || !file.name.endsWith('.key')) {
            alert("Por favor, carga un archivo file.key");
            return null;
    }

    const reader = new FileReader();
    return new Promise((resolve, reject) => {
        reader.onload = function(e) {
            const encryptedKey = e.target.result;
            try {
                // Intentamos desencriptar la clave privada usando la contraseña
                const decryptedKey = CryptoJS.AES.decrypt(encryptedKey, password).toString(CryptoJS.enc.Utf8);
                if (decryptedKey) {
                    resolve(decryptedKey);
                } else {
                    reject("No se pudo desencriptar la clave.");                 
                    alert(`Invalid (key or paswword)`);

        
                }
            } catch (error) {
                reject("Error al procesar el archivo. Asegúrate de ingresar la contraseña correcta.");
            }
        };
        reader.onerror = function() {
            reject("Error al leer el archivo.");
        };
        reader.readAsText(file);  // Lee el archivo como texto
    });
}


    // Verifica la existencia de una billetera al cargar la página
   // window.onload = check_privatekey;

    // Función para cargar el archivo y recuperar la clave privada
    function cargarArchivo() {
        const inputFile = document.createElement('input');
        inputFile.type = 'file';
        inputFile.accept = '.key';
        inputFile.onchange = async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const encryptedKey = e.target.result;
                    const password = document.getElementById('password').value.trim();
                    if (password && encryptedKey) {
                        try {
                            // Intentamos desencriptar la clave privada usando la contraseña
                            const decryptedKey = CryptoJS.AES.decrypt(encryptedKey, password).toString(CryptoJS.enc.Utf8);
                            //alert(`Clave privada desencriptada: ${decryptedKey}`);
                        } catch (error) {
                            alert("selecciona el key correcto. Asegúrate de ingresar la contraseña correcta.");
                        }
                    }
                };
                reader.readAsText(file);
            }
        };
        inputFile.click();  // Simula el clic para abrir el selector de archivos
    }
</script>

</body>
</html>